pipeline {
    agent any

    environment {
        CLIENT_ID = '93eaa24a-e6b6-4f3a-b5f2-b318a9ef7d50' // Azure Service Principal Client ID
                CLIENT_SECRET = 'BKU8Q~ZNHLISNgi_kDF9HeB~TISLdEV9EV4-MacC' // Azure Service Principal Client Secret
                TENANT_ID = '118b2919-e434-405b-9f3c-3a829eba55f9' // Azure Tenant ID
                RESOURCE_GROUP = 'Demo_Pract' // Azure Resource Group
                APP_NAME = 'Demo-backendcode' // Azure Web App Name
                REPO_URL = 'https://github.com/MiddlewareTalent/dummyBackend.git    ' // Git Repository URL
                GIT_CREDENTIALS = 'Git' // Jenkins Git Credentials ID
    }
     triggers {
                 pollSCM('*/2 * * * *') // Corrected polling interval for every 5 minutes
         }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                     url: env.REPO_URL,
                     credentialsId: env.GIT_CREDENTIALS
            }
        }

        stage('Build') {
            steps {
                bat 'mvn clean install'
            }
        }

        stage('Login to Azure') {
            steps {
                bat """
                    az login --service-principal \
                    -u ${env.CLIENT_ID} \
                    -p ${env.CLIENT_SECRET} \
                    --tenant ${env.TENANT_ID}
                """
            }
        }

        stage('Deploy to Azure App Service') {
            steps {
                bat """
                    az webapp deploy \
                    --resource-group ${env.RESOURCE_GROUP} \
                    --name ${env.APP_NAME} \
                    --src-path target/ems-backend-0.0.1-SNAPSHOT.jar \
                    --type jar
                """
            }
        }
    }

    post {
        success {
            echo 'Deployment to Azure App Service succeeded!'
        }
        failure {
            echo 'Deployment to Azure App Service failed!'
        }
    }
}